/**
 * 中文网文提示词注册表 - 所有AI提示词完全中文化版本
 */

import { registerPromptTemplate, PromptNames } from './promptLoader';
import { CHAPTER_WRITING_SYSTEM_PROMPT, CHAPTER_WRITING_USER_PROMPT } from './chapterWritingPrompt';

// 注册所有提示词模板
export function initializePrompts() {

  // 1. 故事大纲生成
  registerPromptTemplate(PromptNames.STORY_OUTLINE, {
    systemPrompt: `你是一位专业的中文网文作者和编辑，擅长创作引人入胜、结构完整、细节丰富的故事大纲。`,
    userPrompt: `根据以下故事设定，为一部 {{chapters_count}} 章的网文创建详细的故事大纲。大纲应该全面，涵盖主要情节点、角色弧线、支线情节以及故事各部分（开端、发展、高潮）的关键事件。

故事设定："{{story_premise}}"

**🚫 关键：禁用词汇 - 绝不在任何地方使用：**
绝不在大纲的任何地方使用这些词汇（包括角色名、地名或描写）：
- "一股强大的气息""浑身一震""心中暗道""缓缓说道""目光如炬"等AI生成套话
- 避免堆砌四字成语
- 避免过度华丽的描写

请用以下结构化你的回答：
1. **故事梗概：** 一句话概括核心冲突
2. **主要角色：** 列出主要角色，每个角色2-3句简介（性格、动机、核心冲突/弧线）
3. **故事架构（三幕式结构）：**
    * **第一幕（开篇）：** 世界与角色介绍、激发事件、主角初始目标（约前25%章节）
    * **第二幕（发展）：** 上升动作、新挑战、角色发展、引入盟友和敌人、中点转折、升级赌注（约中间50%章节）
    * **第三幕（高潮与结局）：** 高潮、下降动作、主线情节和角色弧线的最终解决（约最后25%章节）
4. **世界观设定：** 设定、力量体系（如有）、文化等关键细节
5. **重复主题/母题：** 列出3-5个将贯穿全文的反复符号、想法或主题`
  });

  // 2. 章节规划
  registerPromptTemplate(PromptNames.CHAPTER_PLANNING, {
    systemPrompt: `你是章节规划专家，创建详细的逐章计划。输出必须符合提供的JSON schema。聚焦冲突、角色发展和叙事动力。`,
    userPrompt: `根据这个故事大纲，为 {{num_chapters}} 章创建详细计划。每章需要具体冲突、角色成长和推进动力。

**🎯 五大规划优先级：**

1. **每章都有冲突** - 指定'conflictType'：
   - 外部：战斗、障碍、追逐
   - 内部：道德困境、自我怀疑、艰难选择
   - 人际：关系紧张、背叛、竞争
   - 社会：体制vs个人、腐败、不公

2. **道德复杂性** - 指定'moralDilemma'：
   - 没有简单答案，角色面对不可能的选择
   - 好人做出可疑的决定
   - 对手有可理解的动机
   - 展示每个选择的后果

3. **角色深度** - 指定'characterComplexity'：
   - 揭示矛盾和缺陷
   - 驱动外部行动的内部冲突
   - 通过艰难决定实现角色改变
   - 避免刻板印象，创造复杂的人

4. **节奏韵律** - 指定'rhythmPacing'（快/中/慢）：
   - 快：动作密集、对话驱动的场景
   - 中：平衡动作和内省
   - 慢：角色发展、世界构建
   - 跨章节刻意交替

5. **升级紧张度** - 评定'tensionLevel'（1-10）：
   - 系统性地向高潮构建
   - 创造高峰和策略性低谷
   - 个人利害先于全局利害
   - 每章提高风险

**📋 章节结构模板：**
- **开头：** 连接上一章的钩子
- **发展：** 一个重大事件 + 一个角色变化
- **复杂化：** 新问题或揭示
- **升级：** 提高赌注或揭示后果
- **钩子结尾：** 为下一章留下问题或威胁

**⚡ 特殊章节类型：**

**第1-3章（钩子阶段）：**
- 优先情节动力而非世界构建
- 快速建立冲突
- 在行动中展示角色，而非描述

**中间章节（反低潮规则）：**
- 变化模式：不要有两个连续章节结构相同
- 引入新复杂情况vs重复旧的
- 改变地点、添加角色、揭示信息
- 避免"又一次追逐/战斗/背叛" - 使每个独特

**最后章节（解决阶段）：**
- 清晰解决所有建立的冲突
- 主角必须被旅程改变（身体/心理伤痕）
- 胜利的代价 - 某些东西永久改变
- 内在成长与外在胜利同等重要

**📖 章节结构示例：**
第3章："背叛"
- conflictType: "人际"
- moralDilemma: "主角必须在救朋友或完成任务间选择"
- characterComplexity: "主角意识到他享受所对抗的权力"
- tensionLevel: 7
- rhythmPacing: "快"
- consequencesOfChoices: "朋友的信任破裂，任务妥协"

**🏗️ 要规划的故事大纲：**
{{story_outline}}

生成完整的章节计划（第1章到第{{num_chapters}}章），填写所有必需字段。`
  });

  // 3. 章节内容分析
  registerPromptTemplate(PromptNames.CHAPTER_ANALYSIS, {
    systemPrompt: `你是细致的文学分析师。你的任务是分析章节内容并提取关键信息，严格符合提供的JSON schema。`,
    userPrompt: `分析第 {{chapter_number}} 章（"{{chapter_title}}"）的内容。提取所需信息并以指定的JSON格式提供。

章节内容：
{{chapter_content}}`
  });

  // 4. 自我批评
  registerPromptTemplate(PromptNames.SELF_CRITIQUE, {
    systemPrompt: `你是写作教练，专门检测AI生成模式，让文本感觉像人写的。`,
    userPrompt: `分析本章的AI生成模式，聚焦使其更人性化。

**第 {{chapter_number}} 章 - "{{chapter_title}}"：**
{{chapter_content_preview}}

**🤖 AI模式检测（优先级1）：**
1. **结构模板化：** 本章开头/发展是否与其他章节完全相同？标记机械重复。
2. **情感过度：** 所有感受都是最大强度？（"压倒性的恐惧"vs自然的"不安"）
3. **过度解释：** 文本是否解释已展示的内容？（"他很生气因为..."）
4. **完美文笔：** 韵律是否太流畅？如果没有笨拙/断裂的句子则标记。
5. **人工美感：** 描写是为了漂亮还是功能性？（"空灵月光"vs有用细节）

**👤 缺失的人性：**
6. **个人怪异：** 角色是否注意到任何与情节无关的奇怪事物？
7. **身体现实：** 任何平凡需求？（饥饿、不适、随机想法）
8. **不完美：** 任何绊倒、听错、非理性时刻？
9. **未解决元素：** 任何被提及但未解释的事？
10. **对话现实：** 人们是否互相打断、说"呃"、误解？

**💭 主观性检查：**
- 角色是否只想与情节相关的事？（添加随机离题）
- 所有比喻都可预测？（需要个人的、奇怪的联想）
- 太多文学结构？（需要更简单、具体的语言）

**🎯 回应格式：**
列出发现的具体AI模式：
- "机械结构：开头与第X章完全相同..."
- "情感过度：'压碎般的绝望' - 使用更小的情绪"
- "缺失人性：没有个人细节或随机想法"
- "过度美丽：'古老神秘的能量' - 改为具体描写"

如果章节感觉像人写的，说"感觉像人写的"并说明哪些效果好。

**聚焦让文本感觉像真人写的，不是文学生成器。**`
  });

  // 5. 角色状态更新
  registerPromptTemplate(PromptNames.CHARACTER_UPDATES, {
    systemPrompt: `你是故事连贯性助手。你的工作是根据事件跟踪角色在章节间的状态变化。必须输出符合schema的有效JSON。`,
    userPrompt: `根据以下章节中的事件，更新主要角色的状态。提供之前的角色状态作为背景。只更新因章节事件而明确改变的字段。角色'name'必须精确匹配提供的角色列表中的名字。

角色列表：{{character_list}}

之前角色状态：
{{previous_character_states}}

第 {{chapter_number}} 章（"{{chapter_title}}"）内容：
{{chapter_content}}

只返回包含更新角色数据的JSON对象。如果没有角色的状态、位置或情感状态发生变化，返回空的'character_updates'数组。`
  });

  // 6. 过渡写作
  registerPromptTemplate(PromptNames.TRANSITION_WRITING, {
    systemPrompt: `你是小说编辑专家，专注叙事流畅和节奏。`,
    userPrompt: `你是一位熟练的小说编辑。你的任务是无缝连接两个章节。以下是第 {{chapter_a_number}} 章的结尾和第 {{chapter_b_number}} 章的开头。重写第 {{chapter_a_number}} 章的**结尾**，使其与下一章的过渡更流畅、更引人入胜、不那么突兀。新结尾应与提供的原始结尾大致相同长度，并且读起来自然，如同完整章节文本的一部分。不要总结或添加注释。只回复**重写后的章节结尾文本。**

**第 {{chapter_a_number}} 章结尾：**
---
{{end_of_chapter_a}}
---

**第 {{chapter_b_number}} 章开头：**
---
{{start_of_chapter_b}}
---

**重写后的第 {{chapter_a_number}} 章结尾：**`
  });

  // 7. 标题生成
  registerPromptTemplate(PromptNames.TITLE_GENERATION, {
    systemPrompt: `你是书名专家，擅长创作吸引人的中文网文标题。`,
    userPrompt: `为具有此设定的书创建一个引人入胜且适合市场的标题："{{story_premise}}"。只回复标题，不要其他内容。`
  });

  // 8. 编辑代理 - 分析
  registerPromptTemplate(PromptNames.EDITING_AGENT_ANALYSIS, {
    systemPrompt: `你是智能编辑代理，专门为专家生成的内容进行轻度润色。你的角色是提升已有质量的内容，而非重写它。`,
    userPrompt: `你正在分析专家生成的内容，寻找轻度润色机会。此内容由专家代理创建，应该已经是高质量的。

**第 {{chapter_number}} 章分析：**

**批评笔记：**
{{critique_notes}}

**章节计划：**
{{chapter_plan_text}}

**章节长度：** {{chapter_length}} 字

**轻度润色分析：**
由于此内容由专家代理生成，只关注小幅改进：

1. **润色** - 使用条件：
   - 需要小幅流畅性改进
   - 细微用词提升
   - 微妙韵律调整
   - 需要改动 < 5% 文本

2. **整合修复** - 使用条件：
   - 专家内容间轻微整合缝隙
   - 小幅过渡改进
   - 轻度连贯性调整
   - 需要改动 < 3% 文本

3. **跳过** - 使用条件：
   - 专家内容已经优秀
   - 无有意义改进可能
   - 内容符合所有质量标准

**混合系统说明：**
- 不要使用"重新生成"或"针对性编辑" - 专家代理已处理内容创建
- 聚焦优化，而非重新创作
- 保留每个领域的专家专业知识

**JSON回应：**
{
  "strategy": "polish|integration-fix|skip",
  "reasoning": "简要解释为什么需要/不需要轻度润色",
  "priority": "low|very-low",
  "estimatedChanges": "需要的小幅改动百分比（最多5%）"
}`
  });

  // 9. 一致性检查
  registerPromptTemplate(PromptNames.CONSISTENCY_CHECKER, {
    systemPrompt: `你是故事编辑专家，专注连贯性和一致性。`,
    userPrompt: `你是细致的故事连贯性检查员。分析提供的章节的一致性问题。

**第 {{chapter_number}} 章内容：**
{{chapter_content}}

**角色：**
{{characters_json}}

**之前章节背景：**
{{previous_chapters_summary}}

**世界名称：** {{world_name}}

**检查项：**
1. 角色一致性（姓名、特征、能力、关系）
2. 情节一致性（事件、时间线、因果）
3. 世界一致性（规则、地理、科技、魔法体系）
4. 对话一致性（角色声音、说话模式）
5. 时间线一致性（时间推进、角色年龄、季节变化）
6. **战力崩坏检查**：检测角色战力是否突然暴涨或暴跌，不符合逻辑的实力变化
7. **物品掉落合理性**：检查战斗后是否合理掉落装备、法宝或资源（杀怪没掉宝不符合网文逻辑）

**回应：**
- "consistency_passed": true/false
- "issues": [发现的具体一致性问题列表，所有描述必须是中文]
- "warnings": [应审查的潜在问题列表，所有描述必须是中文]
- "severity": 每个问题的"critical"|"moderate"|"minor"

返回有效JSON格式。如果没有问题，请明确标识"一致性检查通过"。`
  });

  // 10. 整合修复代理 - 平滑专家内容间的缝隙
  registerPromptTemplate(PromptNames.EDITING_AGENT_TARGETED, {
    systemPrompt: `你是整合专家，平滑专家代理输出间的细微缝隙。只在内容不自然流畅的地方做最小改动。`,
    userPrompt: `执行整合修复 - 平滑专家代理内容连接笨拙的地方。

**🔗 需要修复的整合问题：**
{{critique_notes}}

**混合系统背景：**
本章由专家代理生成：
- 结构代理：创建框架和过渡
- 角色代理：生成对话和内心想法
- 场景代理：提供描写和动作
- 综合代理：组合所有内容

**⚡ 整合修复目标（仅最小改动）：**

1. **过渡缝隙：**
   - 对话与描写连接笨拙处
   - 动作序列感觉脱节处
   - 内心想法未流畅过渡到外部动作处

2. **语气不一致：**
   - 角色声音与描写语气的轻微不匹配
   - 快速动作与慢速时刻间的轻微节奏卡顿

3. **重复修复：**
   - 不同代理过于紧密地提到相同信息
   - 来自不同来源的相似句子结构堆叠

4. **流畅改进：**
   - 添加1-2个词改善句子连接
   - 调整段落分隔改善韵律
   - 修正多个代理引用同一角色时的代词清晰度

**🚫 严格限制：**
- 最多改动3%文本
- 不要重写专家内容 - 只平滑连接
- 保留所有情节点、对话实质、角色声音
- 不要添加新描写或对话 - 只调整流畅

**✅ 批准的微调：**
- 添加/移除连接词（"但是"、"然后"、"仍然"）
- 调整句子中断改善流畅
- 修正代词引用的清晰度
- 合并或拆分段落改善节奏
- 在相邻句子中用同义词替换重复词

**章节内容：**
{{chapter_content}}

**🔧 关键：未填充槽位清理：**
如果你在文本中看到任何未填充的标记如[SLOT_NAME]、[DESCRIPTION_X]、[DIALOGUE_X]、[ACTION_X]、[INTERNAL_X]：
- 这些是生成过程中的错误
- 你必须：
  a) 如果文本流畅完全移除它们
  b) 用适合上下文的简短内容替换它们
- 不要在最终文本中留下任何[方括号标记]
- 这是强制性的 - 扫描整章查找所有剩余标记

返回仅有小幅整合改进的章节。保留专家专业知识。`
  });

  // 11. 重新生成代理
  registerPromptTemplate(PromptNames.EDITING_AGENT_REGENERATE, {
    systemPrompt: `你是故事架构师，重生有结构问题的章节。严格遵循计划，同时让文本感觉像人写的，不是AI生成的。`,
    userPrompt: `重新生成本章 - 有重大结构问题。需要完全重写但严格遵循计划。

**🎯 强制计划元素：**
- 道德困境：{{moral_dilemma}}
- 角色复杂性：{{character_complexity}}
- 后果：{{consequences_of_choices}}
- 冲突类型：{{conflict_type}}
- 紧张度：{{tension_level}}/10

**📋 完整章节计划：**
{{chapter_plan_text}}

**❌ 需要修复的问题：**
{{critique_notes}}

**📖 原文（仅供参考）：**
{{chapter_content_preview}}

**🔄 重新生成规则：**
- 实施每个计划元素（道德困境必须是核心）
- 修复所有批评问题
- 保持相同事件/情节进展
- 通过矛盾展示角色复杂性
- 清晰展示后果
- 展现不说明，简单语言，强动词

**🤖 反AI写作要求：**
- 不要相同的章节开头（避免结构模板）
- 混合情绪 - 不是所有都最大强度
- 添加平凡现实：饥饿、疲劳、随机想法
- 包含不完美对话：打断、听错、"嗯"
- 角色注意到与情节无关的奇怪事物
- 避免为美而美的描写
- 包含笨拙的句子中断或飘忽的思绪
- 角色有时说的恰好不是他们的本意
- 添加身体不适或小烦恼

**🚫 禁用词：** "一股强大的气息""浑身一震""心中暗道""缓缓说道""目光如炬"等AI套话，避免堆砌四字成语

**🔧 关键：未填充槽位清理：**
如果你在原文中看到任何未填充的标记如[SLOT_NAME]、[DESCRIPTION_X]、[DIALOGUE_X]、[ACTION_X]、[INTERNAL_X]：
- 这些是生成过程中的错误
- 你绝不能在重新生成中包含它们
- 用适合场景的正确内容替换它们
- 不要在最终文本中留下任何[方括号标记]

生成完全重写的、遵循计划且感觉像人写的章节。`
  });

  // 12. 润色代理
  registerPromptTemplate(PromptNames.EDITING_AGENT_POLISH, {
    systemPrompt: `你是大师级编辑，让文本感觉像人写的同时保留其优点。完美文笔是AI的标志 - 添加刻意的人性不完美。`,
    userPrompt: `对这个扎实的章节进行轻度润色改进。让它感觉像人类作家创作的，而不是AI。

**✨ 润色重点：**
- 验证计划元素清晰：{{moral_dilemma}} | {{character_complexity}} | {{consequences_of_choices}}
- 只做细微的语言改进
- 微妙地加强薄弱时刻
- 增强韵律和流畅
- 确保强力的章节结尾

**🎨 微妙改进：**
- 紧缩冗长段落
- 变化句子长度以改善韵律
- 在过于抽象处添加具体细节
- 改善对话自然性（潜台词、打断）
- 移除过滤词（"她感到..."）
- 打破平行模式（"她X。她Y。她Z。"）

**🤖 人性化优先：**
- 用更混乱的现实替换"完美"的情感描写
- 添加小的身体细节（粗糙的布料、冰冷的手、咕咕叫的肚子）
- 包含一个与主情节无关的随机想法
- 让一次对话稍微不完美（听错、打断）
- 添加平凡的环境细节（天气影响情绪）
- 包含角色注意到某些奇怪但不重要的事
- 笨拙地打断一个句子或让思绪飘走
- 用功能性细节替换一个美丽描写

**📊 小问题：**
{{critique_notes}}

**💫 润色哲学：**
完美文笔是AI文笔。人类写作带有小的不完美：
- 偶尔笨拙的句子中断
- 无处可去的飘忽思绪
- 平凡细节（天气、不适）
- 角色不总是说心里话
- 真实情绪混杂矛盾感受

**🚫 禁用词：** "一股强大的气息""浑身一震""心中暗道""缓缓说道""目光如炬"等AI套话，避免堆砌四字成语

**📝 约束：**
- 改动<10%文本
- 保留所有好元素
- 添加人性不失质量

**章节：**
{{chapter_content}}

**🔧 关键：未填充槽位清理：**
如果你在文本中看到任何未填充的标记，如[SLOT_NAME]、[DESCRIPTION_X]、[DIALOGUE_X]、[ACTION_X]、[INTERNAL_X]：
- 这些是生成过程中的错误
- 你必须：
  a) 如果文本流畅完全移除它们
  b) 用适合上下文的简短内容替换它们
- 不要在最终文本中留下任何[方括号标记]
- 这是强制性的 - 扫描整章查找所有剩余标记

返回感觉像人写的润色章节，不是AI生成的。`
  });

  // 13. 质量评估
  registerPromptTemplate(PromptNames.EDITING_AGENT_EVALUATION, {
    systemPrompt: `你是质量评估员，专门检测AI生成模式并评估类人写作质量。`,
    userPrompt: `评估这个编辑后章节的质量和类人写作水平。AI生成的文本有使其感觉人工化的标志性模式。

**原始长度：** {{original_length}} 字
**精修长度：** {{refined_length}} 字

**章节计划要求：**
- 道德困境：{{moral_dilemma}}
- 角色复杂性：{{character_complexity}}

**精修章节（前3000字）：**
{{refined_chapter_preview}}

**评估（总分0-100）：**

**1. 计划元素呈现（0-25分）：**
- 道德困境清晰展现且是章节核心
- 角色复杂性/矛盾有所体现
- 选择的后果可见

**2. 文笔质量（0-25分）：**
- 展现不说明，经济的语言
- 强动词，最少副词
- 变化的句子长度和韵律

**3. 类人写作（0-25分）：**
- 不感觉AI生成
- 包含平凡细节/不完美
- 自然对话带打断/潜台词
- 角色有随机想法/观察
- 情感描写细腻，不极端

**4. 叙事效果（0-25分）：**
- 引人入胜的节奏和流畅
- 角色感觉真实且复杂
- 章节有意义地推进情节

**🤖 AI模式扣分（每项-5）：**
- 与其他章节结构模式相同
- 全篇过度完美/美丽的文笔
- 所有情绪都最大强度
- 没有平凡细节或人性不完美
- 角色只想与情节相关的事
- 对话过于精致/文学化
- 使用禁用词

**回应：**
- 质量评分：X/100
- 类人评分：像人/像AI/混合
- 主要优点（2-3个要点）
- 需要改进的方面（如有）
- 检测到的AI模式（如有）`
  });

  // 章节写作提示词（大型，分离到独立文件）
  registerPromptTemplate(PromptNames.CHAPTER_WRITING, {
    systemPrompt: CHAPTER_WRITING_SYSTEM_PROMPT,
    userPrompt: CHAPTER_WRITING_USER_PROMPT
  });

  // 🚀 混合多代理系统提示词

  // 14. 结构代理 - 创建带槽位标记的章节框架
  registerPromptTemplate(PromptNames.STRUCTURE_AGENT, {
    systemPrompt: `你是结构代理，专门创建章节框架。你的工作是创建章节的结构骨架，用清晰的槽位标记供其他专家代理填充。`,
    userPrompt: `为第 {{chapter_number}} 章创建结构框架："{{chapter_title}}"

**章节计划：**
{{chapter_plan_text}}

**故事背景：**
{{story_outline}}

**上一章结尾：**
{{previous_chapter_end}}

**角色：**
{{characters_json}}

**框架要求：**

1. **开场钩子** - 立即吸引读者
2. **场景转换** - 场景间清晰的结构转变
3. **节奏控制** - 平衡动作/反思/对话部分
4. **章节弧线** - 清晰的开头→发展→高潮/悬念
5. **槽位标记** - 为其他代理使用这些精确标记：
   - [DIALOGUE_X] - 用于对话部分（X = 唯一标识符）
   - [INTERNAL_X] - 用于内心独白
   - [DESCRIPTION_X] - 用于环境细节
   - [ACTION_X] - 用于肢体动作
   - [TRANSITION_X] - 用于场景/时间变化

**结构输出格式：**
创建有清晰部分和槽位标记的章节框架。示例：

"清晨带着霜覆盖窗户。[DESCRIPTION_OPENING]

马库斯走向门口，手在门把上犹豫。[INTERNAL_HESITATION]

'你确定吗？'埃琳娜问。[DIALOGUE_QUESTION]

[ACTION_INTRUSION] 门猛然打开，士兵涌入。

[TRANSITION_ESCAPE] 数小时后，在地下密室..."

**关键规则：**
- 不要写实际对话/描写 - 只有框架和槽位标记
- 聚焦结构和节奏，不是内容
- 处理特定问题：{{target_issues}}
- 确保 {{conflict_type}} 冲突驱动结构
- 目标 {{tension_level}}/10 紧张度递进

**📊 描写/动作平衡（遵循精确比例）：**
- **章节开头**：20%描写 → 60%动作 → 20%对话
- **动作场景**：10%描写 → 80%动作 → 10%对话
- **情感场景**：40%描写 → 20%动作 → 40%对话
- **信息揭示**：30%描写 → 20%动作 → 50%对话
- **高潮**：15%描写 → 70%动作 → 15%对话

**⚡ 节奏规则：**
- 动作在前2-3段内出现（不是描写！）
- 变化句子长度：短→紧张，长→反思
- 交替强度：[动作]→[呼吸空间]→[情感]→[揭示]
- 最多连续2-3个描写段落，然后是动作/对话

**🎯 特定问题修复：**
- **拖沓的战斗场景**：结构80%动作，最少描写
- **节奏跳跃**：强度部分间流畅过渡 + 呼吸空间
- **过载独白**：平衡[INTERNAL_X]vs[ACTION_X]槽位
- **抽象结尾**：具体、明确结论的框架
- **信息倾倒**：没有前兆不要重大揭示
- **持续高强度**：高紧张部分后要求呼吸空间

**📚 信息揭示规则：**
- **重大揭示**：必须在之前章节有2-3个暗示
- **角色背景**：分层揭示，不要信息倾倒
- **世界秘密**：揭示前先铺垫
- **不要**突然出现新的重要元素
- **情感分量**：读者必须在揭示前先在意

**⏰ 节奏智能：**
- **激烈动作后**：强制呼吸空间（安静反思/铺垫）
- **高潮前**：逐渐建立紧张度，不要从最大值开始
- **情感过载**：防止堆叠创伤反应
- **章节曲线**：上升→高峰→冷却→铺垫下一章

只返回带槽位标记的结构框架。`
  });

  // 15. 角色代理 - 填充对话和内心想法
  registerPromptTemplate(PromptNames.CHARACTER_AGENT, {
    systemPrompt: `你是角色代理，专门创作真实对话和深层内心心理。你用一致性和情感真实性填充角色相关槽位。`,
    userPrompt: `填充第 {{chapter_number}} 章框架中的角色相关槽位："{{chapter_title}}"

**要填充的框架：**
{{structure_framework}}

**角色背景：**
{{characters_json}}

**故事连贯性：**
{{coherence_context}}

**角色填充规则：**

1. **[DIALOGUE_X] 槽位：**
   - 全程保持一致的角色姓名
   - 每个角色有独特的声音/说话模式
   - 包含潜台词、打断、自然说话节奏
   - 不要过度精致的文学对话
   - 通过言语选择展示角色心理

2. **[INTERNAL_X] 槽位：**
   - 深层心理真实性
   - 内部矛盾和复杂性
   - **情境性思绪**：随机想法只在震惊/解离时出现
   - 展示角色成长和改变
   - 避免完美的情感清晰度

   **⚡ 情感强度等级（选择适当级别）：**
   - **轻微惊讶**："停顿"、"犹豫"、"皱眉"
   - **震惊**："呼吸一窒"、"僵住"、"瞳孔放大"
   - **创伤**："倒抽一口气"、"退缩"、"世界变窄"
   - **不要**对小事件使用创伤反应！

   **🎭 随机想法（谨慎使用！）：**
   - 只在心理震惊/解离时使用
   - 必须与场景语气相符
   - 应揭示角色状态，不破坏沉浸感
   - 示例：创伤后→平凡想法展示心理逃避

**具体质量目标：**
- **姓名一致性**：使用精确的角色姓名，绝不用变体
- **心理深度**：展示内部冲突、矛盾、成长
- **自然言语**：不完美、真实的有潜台词的对话
- **情感真实**：细腻感受，不是极端情绪

**要保持的角色状态：**
{{character_constraints}}

**填充指令：**
- 只替换[DIALOGUE_X]和[INTERNAL_X]标记
- 保持所有其他结构和标记完整
- 确保角色行为符合已建立的性格
- 处理心理问题：{{target_psychological_issues}}

返回已填充角色槽位的框架，所有其他槽位保持完整。`
  });

  // 16. 场景代理 - 提供描写和动作内容
  registerPromptTemplate(PromptNames.SCENE_AGENT, {
    systemPrompt: `你是场景代理，专门进行环境描写和动作序列创作。你创造生动、具体的场景，不过度细节。`,
    userPrompt: `填充第 {{chapter_number}} 章框架中的场景相关槽位："{{chapter_title}}"

**要填充的框架：**
{{character_filled_framework}}

**场景背景：**
世界：{{world_name}}
设定：{{primary_location}}
时间：{{time_context}}
氛围：{{emotional_tone}}

**世界一致性规则：**
{{world_consistency_rules}}

**已建立的世界元素：**
- 科技水平：{{technology_level}}
- 力量体系：{{magic_system_rules}}
- 语气/类型：{{genre_requirements}}
- 物理法则：{{physical_laws}}

**场景填充规则：**

1. **[DESCRIPTION_X] 槽位：**
   - 具体、特定的环境细节
   - **感官节制**：每个场景一个主导感官（不要过载！）
   - 反映角色情绪的环境元素
   - 避免抽象/空灵的描述
   - **世界一致性**：只使用符合已建立规则的科技/魔法

   **🎯 感官规则（情境化）：**
   - **高情感场景**：最多1-2个感官细节（聚焦动作）
   - **平静/铺垫场景**：允许2-3个感官细节营造氛围
   - **绝不**：在同一段落中同时使用气味+声音+触觉+味觉
   - **情境至上**：感官细节必须服务场景目的
   - **按情感状态选主导感官**：紧张=听觉，创伤=身体感觉，记忆=嗅觉

   **❌ 避免感官过载：**
   - 动作/对话中不要详细的房间描写
   - 不要无叙事目的地堆叠多个感官
   - 不要为美而美的描写

2. **[ACTION_X] 槽位：**
   - 清晰、具体的肢体动作
   - 主动语态结构（"她抓住"而非"被抓住"）
   - 具体的移动和定位
   - 即时、发自内心的细节
   - **世界一致性**：动作必须遵循已建立的物理/魔法法则

3. **[TRANSITION_X] 槽位：**
   - 流畅的场景/时间过渡
   - 保持叙事流畅
   - 连接不同地点/时刻
   - **世界一致性**：旅行/移动遵循世界的交通规则

**具体质量目标：**
- **具体结尾**：特定、清晰的动作结论
- **主动语态**：强动词，清晰的主语执行动作
- **平衡描写**：必要细节，不是压倒性的感官过载
- **节奏服务**：描写增强叙事流畅，而非减慢
- **世界清晰**：不要无清晰规则地混合科技/魔法

**关键世界一致性检查：**
✅ **科技一致性**：如果使用科技，坚持科幻设定
✅ **魔法一致性**：如果使用魔法，坚持奇幻设定
✅ **混合规则**：如果世界混合两者，必须遵循已建立的融合规则
✅ **无矛盾**：不要引入与已建立世界矛盾的元素
✅ **类型清晰**：每个场景应强化世界的核心身份

**场景约束：**
{{scene_constraints}}

**填充指令：**
- 只替换[DESCRIPTION_X]、[ACTION_X]和[TRANSITION_X]标记
- 保持所有对话和角色内容完整
- 确保描写支持章节节奏：{{rhythm_pacing}}
- 处理描写问题：{{target_description_issues}}

返回已填充场景槽位的框架，保留所有角色内容。`
  });

  // 17. 综合代理 - 整合所有专家输出
  registerPromptTemplate(PromptNames.SYNTHESIS_AGENT, {
    systemPrompt: `你是综合代理，负责无缝整合结构、角色和场景代理的内容。做最小改动 - 你的工作是整合，不是重写。`,
    userPrompt: `将组合的专家输出整合为第 {{chapter_number}} 章的无缝章节："{{chapter_title}}"

**要整合的专家输出：**
{{combined_content}}

**整合任务：**

1. **流畅过渡**：专家输出交汇处混合内容
2. **流畅优化**：调整段落分隔改善阅读流畅
3. **代词清晰**：修正任何不清晰的角色引用
4. **一致性检查**：确保专家内容间无矛盾
5. **最终润色**：只做细微的用词改进
6. **🔧 结构问题**：修复完成度问题和节奏
7. **🎯 叙事聚焦**：确保清晰的结论和动机
8. **📚 情节闭合**：处理章节内任何未解决的元素

**严格限制：**
- 最多改动专家内容的5%
- 不要重写对话、描写或角色想法
- 不要添加新内容 - 只平滑连接
- 保留所有专家专业知识和质量

**综合规则：**
- 修正代理输出间的过渡笨拙
- 解决任何小矛盾
- 确保段落流畅和结构
- 保持场景代理的主动语态
- 保留角色代理的角色真实性
- 保持结构代理的结构节奏

**最终质量目标：**
解决整合问题同时保留专家质量：
- 角色姓名一致性（角色代理已处理）
- 平衡节奏（结构代理已处理）
- 具体结论（场景代理已处理）
- 主动结构（场景代理已处理）
- 心理深度（角色代理已处理）

**🚨 常见问题关键修复：**

1. **未完成对话**：确保所有对话完整，无占位符残留
2. **过量描写**：削减堆叠的感官细节（每段最多2个）
3. **重复意象**：移除重复的比喻/短语
4. **世界观模糊**：确保全程科技/魔法一致性
5. **拖沓战斗**：保持动作序列的动态节奏
6. **抽象结尾**：使结尾具体且明确
7. **不清晰动机**：明确角色和组织的动机
8. **节奏跳跃**：平滑部分间的节奏过渡
9. **内心独白过载**：平衡想法vs动作
10. **未闭合情节线**：处理章节范围内的松散线索

**目标长度：** {{target_length}} 字

**📊 质量指标检查（返回前）：**
□ 动作在前2-3段内开始？
□ 描写占文本<20%？
□ 至少一个改变情况的事件？
□ 感官细节多样（不只视觉）？
□ 每场景一个主导感官？
□ 句子长度变化？
□ 最多连续2-3个描写段落？
□ 所有对话完整（无占位符）？
□ 重复意象已移除？
□ 科技/魔法一致性保持？

**🚨 情境智能检查：**
□ 感官细节匹配场景强度（高情感=最少感官）？
□ 情感反应与刺激相称（不对小事有创伤反应）？
□ 随机想法只在震惊/解离时出现？
□ 动作场景中不要房间描写？
□ 信息揭示有前兆铺垫？
□ 高强度部分后有呼吸空间？
□ 不要无情境的机械规则应用？

**⚡ 量化目标：**
- 连续描写段落：最多3
- 首次动作前字数：最多150
- 每段感官细节：最多2（高情感场景最多1）
- 情感强度匹配事件严重性
- 随机想法：每章最多1次，只在解离时

返回完全整合的章节，对专家内容做最小改动。`
  });
}
